// D:\web-dev\nextjs-tut\e-commerce\app\store\useAuthStore.js
import { create } from 'zustand';
import { createJSONStorage, persist } from 'zustand/middleware';

const useAuthStore = create(
    persist(
        (set) => ({
            isAuthenticated: false,
            user: null,
            setAuth: (userData) => set({ isAuthenticated: true, user: userData }),
            clearAuth: () => set({ isAuthenticated: false, user: null }),
        }),
        {
            name: 'auth-storage',
            storage: createJSONStorage(() => localStorage),
        }
    )
);

export default useAuthStore;
// useCartStore.js
import { create } from 'zustand';
import { persist } from 'zustand/middleware';

// Helper function to check if user is authenticated
const isAuthenticated = () => {
    if (typeof window === 'undefined') return false;
    const user = localStorage.getItem('auth_user');
    return user && user !== 'null';
};

export const useCartStore = create(persist(
    (set, get) => ({
        cart: [],

        clearCart: () => set({ cart: [] }),

        addToCart: (product, selectedSize, selectedColor, quantity = 1) => {
            // Check authentication before adding to cart
            if (!isAuthenticated()) {
                // Store the current URL for redirect after login
                const currentUrl = window.location.pathname + window.location.search;
                localStorage.setItem('redirect_after_login', currentUrl);

                // Redirect to login page
                window.location.href = '/login';
                return false; // Indicate failed addition
            }

            const cart = get().cart;
            const existing = cart.find(item =>
                item.id === product.id &&
                item.size === selectedSize &&
                item.color === selectedColor
            );

            if (existing) {
                // Update quantity
                existing.quantity += quantity;
                set({ cart: [...cart] });
            } else {
                set({
                    cart: [
                        ...cart,
                        {
                            id: product.id,
                            name: product.name,
                            price: product.price,
                            image: product.imageSrc,
                            size: selectedSize,
                            color: selectedColor,
                            quantity,
                        },
                    ]
                });
            }
            return true; // Indicate successful addition
        },

        removeFromCart: (productId, size, color) => {
            const newCart = get().cart.filter(
                item => !(item.id === productId && item.size === size && item.color === color)
            );
            set({ cart: newCart });
        },

        clearCart: () => set({ cart: [] }),

        // Helper method to check if user can modify cart
        canModifyCart: () => isAuthenticated(),

        // Method to update cart quantity
        updateQuantity: (productId, size, color, newQuantity) => {
            if (!isAuthenticated()) return false;

            const cart = get().cart;
            const itemIndex = cart.findIndex(item =>
                item.id === productId && item.size === size && item.color === color
            );

            if (itemIndex !== -1) {
                if (newQuantity <= 0) {
                    // Remove item if quantity is 0 or less
                    cart.splice(itemIndex, 1);
                } else {
                    cart[itemIndex].quantity = newQuantity;
                }
                set({ cart: [...cart] });
                return true;
            }
            return false;
        }
    }),
    {
        name: 'cart-storage',
        // Only persist cart for authenticated users
        partialize: (state) => isAuthenticated() ? { cart: state.cart } : { cart: [] }
    }
));

export const useCartCount = () => useCartStore((state) =>
    state.cart.reduce((total, item) => total + item.quantity, 0)
);
// stores/useWishlistStore.js
import { create } from 'zustand';
import { persist } from 'zustand/middleware';

// Import auth store
import useAuthStore from './useAuthStore';

// Authentication check using auth store
const isAuthenticated = () => {
    if (typeof window === 'undefined') return false;
    return useAuthStore.getState().isAuthenticated;
};

export const useWishlistStore = create(persist(
    (set, get) => ({
        wishlistItems: [],

        addToWishlist: (product) => {
            if (!isAuthenticated()) {
                const currentUrl = window.location.pathname + window.location.search;
                localStorage.setItem('redirect_after_login', currentUrl);
                window.location.href = '/login';
                return false;
            }

            const wishlistItems = get().wishlistItems;
            const existing = wishlistItems.find(item => item.id === product.id);

            if (!existing) {
                set({
                    wishlistItems: [
                        ...wishlistItems,
                        product
                    ]
                });
            }
            return true;
        },

        removeFromWishlist: (productId) => {
            const newWishlist = get().wishlistItems.filter(
                item => item.id !== productId
            );
            set({ wishlistItems: newWishlist });
        },

        clearWishlist: () => set({ wishlistItems: [] }),

        isInWishlist: (productId) => {
            return get().wishlistItems.some(item => item.id === productId);
        }
    }),
    {
        name: 'wishlist-storage',
        partialize: (state) => isAuthenticated() ? { wishlistItems: state.wishlistItems } : { wishlistItems: [] }
    }
));

export const useWishlistCount = () =>
    useWishlistStore((state) => state.wishlistItems.length);